
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cozy Real Estate — MVP</title>
<style>
  :root{
    --bg:#0b1220; --panel:#101826; --ink:#b9d4ff; --muted:#7a8aaa; --good:#65d38a; --warn:#f5b54c; --bad:#ef6461;
    --acc:#7aa2ff; --acc2:#9b8cff;
  }
  html,body{height:100%;}
  body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#e8f0ff; background: radial-gradient(1200px 600px at 30% 0%, #132138, #0b1220 55%);}
  .app{display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; padding:16px; max-width:1100px; margin:0 auto;}
  header{grid-column:1/-1; display:flex; align-items:center; gap:12px; padding:10px 14px; background:#0f192a80; border:1px solid #1f2a44; border-radius:12px; position:sticky; top:8px; backdrop-filter: blur(6px);}
  .pill{background:#192743; border:1px solid #2a3a61; padding:4px 8px; border-radius:999px; font-weight:700; color:#cfe0ff;}
  .stat{display:flex; gap:10px; align-items:baseline; margin-right:18px;}
  .stat .v{font-size:1.6rem; font-weight:800; letter-spacing:.3px; color:#ffffff;}
  .stat .l{font-size:.8rem; color:#9ab0d6}
  .grow{flex:1}
  .btn{cursor:pointer; user-select:none; padding:14px 16px; border-radius:12px; border:1px solid #2a3a61; background:#162443; color:#e8f0ff; font-weight:700; transition:.12s transform, .12s opacity, .12s background; text-align:center;}
  .btn:hover{transform:translateY(-1px); background:#1a2b52;}
  .btn:active{transform:translateY(0); opacity:.9;}
  .btn[disabled]{opacity:.5; filter:grayscale(.3); cursor:not-allowed; transform:none;}
  .card{background:#0f192a; border:1px solid #1e2b4a; border-radius:14px; padding:14px; box-shadow: 0 0 0 1px #0a1325 inset; }
  .col{display:flex; flex-direction:column; gap:16px;}
  .tower{min-height:520px; display:flex; flex-direction:column; justify-content:flex-end; gap:6px; padding:10px; background:linear-gradient(180deg, #0f1a31, #0c1426); border-radius:14px; border:1px solid #1c2a49; overflow:hidden; position:relative;}
  .skyline{position:absolute; inset:0; opacity:.25; background-size:cover; background-position:center bottom; mix-blend:screen; border-radius:14px; pointer-events:none;}
  .tile{height:36px; border-radius:8px; display:flex; align-items:center; gap:10px; padding:6px 8px; background:linear-gradient(180deg, #1a2b52, #152443); border:1px solid #29406b;}
  .icon{width:24px; height:24px; border-radius:6px; background: linear-gradient(160deg, #7aa2ff, #9b8cff); display:grid; place-items:center; font-weight:900; color:#0b1220;}
  .tile .name{font-weight:700; color:#e6eeff;}
  .tile .meta{margin-left:auto; color:#9ab0d6; font-weight:700; font-size:.9rem;}
  .panel{display:grid; gap:12px;}
  .two{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  .notice{font-size:.9rem; color:#a8bbdf}
  .bar{height:10px; background:#0f192a; border:1px solid #1e2b4a; border-radius:999px; overflow:hidden;}
  .bar>div{height:100%; background:linear-gradient(90deg, #3fbf88, #7fd7a7); width:0%;}
  .h2{font-weight:800; color:#d9e6ff; letter-spacing:.2px; margin:4px 0 8px}
  .muted{color:#8da2c7}
  .price{color:#f5d67a; font-weight:800}
  .good{color:#65d38a; font-weight:800}
  .warn{color:#f5b54c; font-weight:800}
  .danger{color:#ef8886; font-weight:800}
  .grid-mini{display:grid; grid-template-columns:repeat(4,1fr); gap:8px;}
  .mini{aspect-ratio:1/1; background:#13223d; border:1px solid #22355a; border-radius:10px; display:grid; place-items:center; font-weight:800; color:#bcd0ff}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .small{font-size:.9rem;}
  .ghost{opacity:.6}
  .footer{grid-column:1/-1; text-align:center; color:#7a8aaa; font-size:.85rem; padding-bottom:12px}
  /* Modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(5,10,20,.55); backdrop-filter: blur(2px);}
  .modal.show{display:grid;}
  .modal .box{background:#101a2d; border:1px solid #22345a; border-radius:16px; width:min(680px, 92vw); padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
  .modal .art{background:#0b1426; border:1px solid #203058; border-radius:12px; aspect-ratio:3/4; display:grid; place-items:center;}
  .modal .controls .h2{margin-top:0}
  input[type="text"]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3a61; background:#0f192a; color:#e8f0ff; font-weight:700;}
  .ghostbtn{background:transparent; border:1px dashed #2a3a61; color:#9ab0d6;}
  @media (max-width: 920px){
    .app{grid-template-columns: 1fr;}
    .modal .box{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <span class="pill">v0.1</span>
    <div class="stat"><span class="l">Cash</span><span id="cash" class="v">0</span></div>
    <div class="stat"><span class="l">Rent / sec</span><span id="rps" class="v">0</span></div>
    <div class="stat"><span class="l">Equity</span><span id="equity" class="v">0</span></div>
    <div class="grow"></div>
    <button class="btn ghostbtn small" id="resetBtn" title="Reset local save">Reset</button>
  </header>

  <div class="col">
    <div class="card tower">
      <div id="skyline" class="skyline"></div>
      <div class="row"><div class="h2">Your City</div><div class="muted small" id="zoneLabel">Zone: Suburb</div></div>
      <div id="stack"></div>
    </div>

    <div class="card">
      <div class="h2">Milestones</div>
      <div class="notice">Buy buildings to unlock new zones and small bonuses.</div>
      <div class="bar" title="Progress to next zone">
        <div id="zoneBar"></div>
      </div>
      <div class="row small" style="margin-top:8px;">
        <div class="muted">Next milestone at <span id="nextMilestone">6</span> buildings</div>
        <div class="good" id="bonusHint">Zone bonus: +10% rent when unlocked</div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card panel">
      <div class="h2">Actions</div>
      <div class="two">
        <button id="dealBtn" class="btn">Deal (+ small cash)</button>
        <button id="buyBtn" class="btn"><span id="buyLabel">Buy next</span> <span class="price" id="buyPrice"></span></button>
      </div>
      <div class="two">
        <div class="card">
          <div class="row"><div class="h2">Renovation</div><div class="muted">Lv <span id="renoLv">0</span>/5</div></div>
          <div class="muted small">Multiply all rent</div>
          <div class="row" style="margin-top:8px;">
            <button id="renoBtn" class="btn small">Upgrade</button>
            <div class="price" id="renoPrice"></div>
          </div>
        </div>
        <div class="card">
          <div class="row"><div class="h2">Manager</div><div class="muted">Lv <span id="mgrLv">0</span>/5</div></div>
          <div class="muted small">Softer price growth</div>
          <div class="row" style="margin-top:8px;">
            <button id="mgrBtn" class="btn small">Upgrade</button>
            <div class="price" id="mgrPrice"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row"><div class="h2">Reinvest</div><div class="muted">Prestige</div></div>
        <div class="muted small">Convert lifetime cash into <b>Equity</b> for a permanent multiplier. Resets buildings & upgrades.</div>
        <div class="row" style="margin-top:8px;">
          <div class="good">Potential Equity: <span id="eqPreview">0</span></div>
          <button id="prestigeBtn" class="btn">Reinvest</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="h2">Portfolio (recent)</div>
      <div id="miniGrid" class="grid-mini"></div>
    </div>
  </div>

  <div class="footer">Cozy Real Estate — single-file MVP (local save). Replace SVG placeholders with AI art later.</div>
</div>

<!-- Deed Modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div class="art" id="deedArt"></div>
    <div class="controls">
      <div class="h2">New Deed</div>
      <div class="muted" style="margin-bottom:8px;">You purchased <b id="deedName"></b>. Give it a nickname and download its PNG certificate.</div>
      <label class="small muted">Nickname</label>
      <input id="deedInput" type="text" placeholder="e.g., Maple St. 12" />
      <div class="row" style="margin-top:12px;">
        <button id="savePngBtn" class="btn">Save PNG</button>
        <button id="closeModalBtn" class="btn ghostbtn">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
function ensureBind(id, fn){
  const el = document.getElementById(id);
  if (!el) return;
  el.removeEventListener('click', fn); el.addEventListener('click', fn);
}

const fmt = (n)=>{
  if (!isFinite(n)) return '0';
  if (n < 1e3) return n.toFixed(0);
  const units = [['',''],['K',''],['M',''],['B',''],['T',''],['Qa',''],['Qi','']];
  let i=0; while(n>=1000&&i<units.length-1){n/=1000;i++;}
  return (Math.floor(n*10)/10).toFixed(1)+' '+units[i][0];
};

// Data: 24 buildings (4 zones × 6)
const ZONES = ['Suburb','Downtown','Seaside','Skyline'];
const milestoneSteps = [6,12,18,24];
function buildingAt(i){
  const names = [
    "Shack","Tiny House","Duplex","Family Home","Townhouse Row","Suburban Plaza",
    "Studio Flat","Corner Café","Boutique Shop","Office Low-Rise","Small Hotel","Business Center",
    "Beach Hut","Fisher’s Cottage","Marina Shop","Boardwalk Café","Seaside Inn","Oceanfront Condo",
    "High-Rise Apt","Tech Hub","Luxury Condo","Corporate Tower","Grand Hotel","Signature Skyscraper"
  ];
  const zone = ZONES[Math.floor((i)/6)]||ZONES[ZONES.length-1];
  const basePrice = 100 * Math.pow(1.7, i);      // simple scalable curve
  const baseRps   = 1   * Math.pow(1.5, i);
  return { id:i+1, name:names[i], zone, price:basePrice, rps:baseRps };
}

// State
const SAVE_KEY = 'cozyRE_mvp_v1';
let S = {
  cash: 0,
  rps: 0,
  equity: 0,
  lifetime: 0,
  buildings: [], // {id,name,zone,price,rps,nick?}
  nextIndex: 0,
  upgrades:{ reno:0, mgr:0 },
  last: Date.now(),
  zoneUnlocked: 0 // 0..3
};

// Load
(function(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (raw){ S = Object.assign(S, JSON.parse(raw)); }
  }catch(e){ console.warn(e); }
  // Offline gains (cap 8h)
  const now = Date.now(); const dt = Math.min(8*3600, Math.max(0, Math.floor((now - (S.last||now))/1000)));
  if (dt>0){
    const gain = getRps() * dt;
    S.cash += gain; S.lifetime += gain; S.last = now;
  }
  renderAll();
})();

function save(){ S.last = Date.now(); localStorage.setItem(SAVE_KEY, JSON.stringify(S)); }
setInterval(save, 3000);

// Economy helpers
function renovationMult(){ return Math.pow(1.25, S.upgrades.reno||0); }
function priceGrowthFactor(){ return 1 - (S.upgrades.mgr||0)*0.02; } // reduces effective growth a bit
function prestigeMult(){ return 1 + 0.05 * (S.equity||0); }

function getRps(){
  const base = S.buildings.reduce((a,b)=>a + b.rps, 0);
  return base * renovationMult() * prestigeMult();
}
function nextBuilding(){
  const idx = S.nextIndex;
  const b = buildingAt(idx);
  // Apply manager softness by slightly reducing price exponent
  const soften = Math.max(0.85, 1 - (S.upgrades.mgr||0)*0.03);
  const adjustedPrice = 100 * Math.pow(1.7*soften, idx);
  b.price = adjustedPrice;
  return b;
}

// Loop
let acc = 0, lastTick = performance.now();
function loop(t){
  const dt = (t - lastTick)/1000; lastTick = t; acc += dt;
  const rps = getRps(); S.rps = rps;
  const gain = rps * dt;
  S.cash += gain; S.lifetime += gain;
  if (acc >= 0.25){ // update UI at 4Hz
    renderHUD(); acc = 0;
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// UI
const elCash = document.getElementById('cash');
const elRps = document.getElementById('rps');
const elEquity = document.getElementById('equity');
const elBuy = document.getElementById('buyBtn');
const elBuyPrice = document.getElementById('buyPrice');
const elBuyLabel = document.getElementById('buyLabel');
const elDeal = document.getElementById('dealBtn');
const elStack = document.getElementById('stack');
const elMini = document.getElementById('miniGrid');
const elRenoLv = document.getElementById('renoLv');
const elRenoPrice = document.getElementById('renoPrice');
const elMgrLv = document.getElementById('mgrLv');
const elMgrPrice = document.getElementById('mgrPrice');
const elPrestige = document.getElementById('prestigeBtn');
const elEqPrev = document.getElementById('eqPreview');
const elZoneBar = document.getElementById('zoneBar');
const elZoneLabel = document.getElementById('zoneLabel');
const elNextMs = document.getElementById('nextMilestone');
const elSky = document.getElementById('skyline');

function renderHUD(){
  elCash.textContent = fmt(S.cash);
  elRps.textContent = fmt(S.rps) + '/s';
  elEquity.textContent = S.equity||0;
  const nb = nextBuilding();
  elBuyPrice.textContent = '— $'+fmt(nb.price);
  elBuyLabel.textContent = 'Buy: '+nb.name;
  elBuy.disabled = S.cash < nb.price;
  // Upgrades
  const renoLv = S.upgrades.reno||0, mgrLv = S.upgrades.mgr||0;
  const renoCost = [500, 2000, 10000, 50000, 200000][renoLv] || null;
  const mgrCost  = [1000,5000, 20000, 100000, 500000][mgrLv] || null;
  elRenoLv.textContent = renoLv; elMgrLv.textContent = mgrLv;
  elRenoPrice.textContent = renoCost? ('$'+fmt(renoCost)) : 'Maxed';
  elMgrPrice.textContent  = mgrCost?  ('$'+fmt(mgrCost)) : 'Maxed';
  document.getElementById('renoBtn').disabled = !renoCost || S.cash < renoCost;
  document.getElementById('mgrBtn').disabled  = !mgrCost  || S.cash < mgrCost;
  // Prestige preview
  const eq = Math.max(0, Math.floor(Math.log10(Math.max(1, S.lifetime)) - 6));
  elEqPrev.textContent = eq;
  elPrestige.disabled = eq <= 0;

  renderStack();
  renderMini();
  renderZone();
}

function renderAll(){ renderHUD(); }
function renderStack(){
  // show latest up to 12 tiles
  const tiles = S.buildings.slice(-12);
  elStack.innerHTML = tiles.map(b=>tileHTML(b)).join('');
}
function tileHTML(b){
  const color = zoneColor(b.zone);
  const letter = b.name.split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase();
  return `<div class="tile" style="background:linear-gradient(180deg, ${shade(color,20)}, ${shade(color,-10)}); border-color:${shade(color,-20)}">
    <div class="icon" style="background: linear-gradient(160deg, ${color}, ${shade(color,-15)});">${letter}</div>
    <div class="name">${escapeHtml(b.nick || b.name)}</div>
    <div class="meta">$${fmt(b.rps)}/s</div>
  </div>`;
}
function renderMini(){
  const tiles = S.buildings.slice(-8);
  elMini.innerHTML = tiles.map(b=>`<div class="mini" title="${escapeHtml(b.name)}">${escapeHtml(short(b.name))}</div>`).join('');
}
function renderZone(){
  const count = S.buildings.length;
  const next = milestoneSteps.find(x=>x>count) || milestoneSteps[milestoneSteps.length-1];
  const prev = milestoneSteps.filter(x=>x<=count).slice(-1)[0] || 0;
  const progress = (count - prev) / (next - prev);
  elZoneBar.style.width = (100*progress).toFixed(1)+'%';
  elNextMs.textContent = next;
  const zoneIdx = Math.floor(count/6);
  S.zoneUnlocked = Math.min(zoneIdx, ZONES.length-1);
  elZoneLabel.textContent = 'Zone: ' + ZONES[S.zoneUnlocked];
  // skyline background
  const skyGrad = [
    'linear-gradient(0deg, rgba(122,162,255,.12), transparent 60%), url("data:image/svg+xml;utf8,'+encodeURIComponent(skylineSVG("#7aa2ff"))+'")',
    'linear-gradient(0deg, rgba(155,140,255,.12), transparent 60%), url("data:image/svg+xml;utf8,'+encodeURIComponent(skylineSVG("#9b8cff"))+'")',
    'linear-gradient(0deg, rgba(34,197,94,.12), transparent 60%), url("data:image/svg+xml;utf8,'+encodeURIComponent(skylineSVG("#22c55e"))+'")',
    'linear-gradient(0deg, rgba(245,181,76,.12), transparent 60%), url("data:image/svg+xml;utf8,'+encodeURIComponent(skylineSVG("#f5b54c"))+'")'
  ][S.zoneUnlocked];
  elSky.style.backgroundImage = skyGrad;
}

function short(n){ return n.length>10 ? n.slice(0,9)+'…' : n; }
function zoneColor(z){
  return {
    'Suburb':'#7aa2ff','Downtown':'#9b8cff','Seaside':'#22c55e','Skyline':'#f59e0b'
  }[z] || '#7aa2ff';
}
function shade(hex, p){
  // p in [-100,100]
  const c = parseInt(hex.slice(1),16);
  let r=(c>>16)&255, g=(c>>8)&255, b=c&255;
  const t = p<0?0:255, P=Math.abs(p)/100;
  r=Math.round((t-r)*P)+r; g=Math.round((t-g)*P)+g; b=Math.round((t-b)*P)+b;
  return `#${(1<<24 | (r<<16)|(g<<8)|b).toString(16).slice(1)}`;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

// Actions
document.getElementById('dealBtn').addEventListener('click', ()=>{
  // Small manual cash: 5% of next price (capped)
  try{
    const price = nextBuilding().price;
    const bonus = Math.min(250, Math.max(25, price * 0.05));
    S.cash += bonus; S.lifetime += bonus;
    renderHUD();
    clickFlash(`+$${fmt(bonus)}`);
  }catch(e){ console.error(e); alert('Deal error: '+e.message); }

});
document.getElementById('buyBtn').addEventListener('click', ()=>{
  const b = nextBuilding(); if (S.cash < b.price) return;
  S.cash -= b.price;
  S.buildings.push(b);
  S.nextIndex++;
  renderHUD();
  openDeedModal(b);
});

document.getElementById('renoBtn').addEventListener('click', ()=>{
  const lv = S.upgrades.reno||0; if (lv>=5) return;
  const cost = [500,2000,10000,50000,200000][lv]; if (S.cash < cost) return;
  S.cash -= cost; S.upgrades.reno = lv+1; renderHUD();
});
document.getElementById('mgrBtn').addEventListener('click', ()=>{
  const lv = S.upgrades.mgr||0; if (lv>=5) return;
  const cost = [1000,5000,20000,100000,500000][lv]; if (S.cash < cost) return;
  S.cash -= cost; S.upgrades.mgr = lv+1; renderHUD();
});

document.getElementById('prestigeBtn').addEventListener('click', ()=>{
  const eq = Math.max(0, Math.floor(Math.log10(Math.max(1, S.lifetime)) - 6));
  if (eq<=0) return;
  if (!confirm(`Reinvest now for ${eq} Equity? This resets buildings & upgrades.`)) return;
  S.equity += eq;
  // reset
  S.cash = 0; S.rps=0; S.buildings=[]; S.nextIndex=0; S.upgrades={reno:0,mgr:0};
  renderHUD(); save();
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  if (!confirm('Reset local save?')) return;
  localStorage.removeItem(SAVE_KEY); location.reload();
});

// Deed Modal
const modal = document.getElementById('modal');
const deedArt = document.getElementById('deedArt');
const deedName = document.getElementById('deedName');
const deedInput = document.getElementById('deedInput');
document.getElementById('closeModalBtn').addEventListener('click', ()=> closeDeedModal());
document.getElementById('savePngBtn').addEventListener('click', ()=> downloadDeedPNG());

let currentDeed = null;
function openDeedModal(b){
  currentDeed = b;
  deedName.textContent = b.name;
  deedInput.value = b.nick || '';
  deedArt.innerHTML = cardSVG(b);
  modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
}
function closeDeedModal(){
  const nick = deedInput.value.trim();
  if (currentDeed){
    currentDeed.nick = nick || undefined;
    // also update in S.buildings
    const idx = S.buildings.findIndex(x=>x.id===currentDeed.id);
    if (idx>=0) S.buildings[idx].nick = currentDeed.nick;
    renderHUD(); save();
  }
  modal.classList.remove('show'); modal.setAttribute('aria-hidden','true');
}

function skylineSVG(color){
  return `<svg xmlns='http://www.w3.org/2000/svg' width='1400' height='540' viewBox='0 0 1400 540'>
    <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='${color}' stop-opacity='0.9'/><stop offset='100%' stop-color='${color}' stop-opacity='0.0'/></linearGradient></defs>
    <rect width='1400' height='540' fill='url(#g)' opacity='0.15'/>
    <g fill='${color}' opacity='.28'>
      <rect x='20' y='320' width='60' height='220' rx='4'/>
      <rect x='120' y='280' width='90' height='260' rx='4'/>
      <rect x='260' y='360' width='110' height='180' rx='4'/>
      <rect x='420' y='300' width='140' height='240' rx='4'/>
      <rect x='620' y='250' width='120' height='290' rx='4'/>
      <rect x='780' y='310' width='80' height='230' rx='4'/>
      <rect x='900' y='270' width='160' height='270' rx='4'/>
      <rect x='1100' y='330' width='100' height='210' rx='4'/>
      <rect x='1240' y='290' width='120' height='250' rx='4'/>
    </g>
  </svg>`;
}

function cardSVG(b){
  const zone = b.zone, color = zoneColor(zone);
  const title = escapeHtml(b.nick || b.name);
  const id = 'art'+Date.now();
  const tag = zone;
  // Simple building silhouette
  return `<svg id="${id}" xmlns="http://www.w3.org/2000/svg" width="750" height="1000" viewBox="0 0 750 1000">
    <defs>
      <linearGradient id="bg" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${shade(color,20)}"/>
        <stop offset="100%" stop-color="${shade(color,-10)}"/>
      </linearGradient>
      <linearGradient id="shine" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#ffffff" stop-opacity=".25"/>
        <stop offset="100%" stop-color="#ffffff00"/>
      </linearGradient>
    </defs>
    <rect x="0" y="0" width="750" height="1000" rx="36" fill="url(#bg)" />
    <rect x="8" y="8" width="734" height="984" rx="30" fill="#0b1220" opacity=".15"/>
    <g transform="translate(60,260)">
      <!-- base tower -->
      <rect x="120" y="120" width="390" height="380" rx="12" fill="${shade(color,-20)}"/>
      <rect x="170" y="80" width="320" height="330" rx="12" fill="${shade(color,-5)}"/>
      <rect x="210" y="40" width="240" height="260" rx="12" fill="${color}"/>
      <!-- windows -->
      ${Array.from({length:6}).map((_,r)=>Array.from({length:6}).map((_,c)=>{
        const x=190 + c*40, y=70 + r*40;
        return `<rect x="${x}" y="${y}" width="18" height="22" rx="3" fill="#0b1220" opacity=".35"/>`;
      }).join('')).join('')}
      <rect x="120" y="120" width="390" height="380" rx="12" fill="url(#shine)"/>
    </g>
    <text x="375" y="820" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-weight="800" font-size="40" fill="#eaf2ff">${title}</text>
    <text x="375" y="870" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-weight="700" font-size="26" fill="#cbd8f3">${tag}</text>
  </svg>`;
}

async function downloadDeedPNG(){
  const svgEl = deedArt.querySelector('svg'); if (!svgEl) return;
  const nick = (deedInput.value.trim() || currentDeed.name).replace(/[^\w\- ]+/g,'');
  const svgData = new XMLSerializer().serializeToString(svgEl);
  const svgBlob = new Blob([svgData], {type:'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.onload = function(){
    const canvas = document.createElement('canvas');
    canvas.width = svgEl.viewBox.baseVal.width || 750;
    canvas.height= svgEl.viewBox.baseVal.height|| 1000;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#0b1220'; ctx.fillRect(0,0,canvas.width, canvas.height);
    ctx.drawImage(img, 0,0);
    canvas.toBlob((blob)=>{
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${nick || 'deed'}.png`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    }, 'image/png');
    URL.revokeObjectURL(url);
  };
  img.src = url;
}

// Render helpers
function renderSkylinePreset(){
  // initial
  elSky.style.backgroundImage = 'linear-gradient(0deg, rgba(122,162,255,.12), transparent 60%), url("data:image/svg+xml;utf8,'+encodeURIComponent(skylineSVG("#7aa2ff"))+'")';
}
renderSkylinePreset();

// Initial population
renderHUD();


// Simple click feedback
const flashHost = document.createElement('div');
flashHost.style.position='fixed'; flashHost.style.left='50%'; flashHost.style.top='74px';
flashHost.style.transform='translateX(-50%)';
flashHost.style.pointerEvents='none'; flashHost.style.zIndex='9999';
document.body.appendChild(flashHost);
function clickFlash(text){
  const el = document.createElement('div');
  el.textContent = text;
  el.style.padding='8px 12px';
  el.style.margin='6px 0';
  el.style.border='1px solid #2a3a61';
  el.style.borderRadius='999px';
  el.style.background='#0f192acc';
  el.style.color='#9ef7c0';
  el.style.fontWeight='800';
  el.style.boxShadow='0 2px 12px rgba(0,0,0,.25)';
  el.style.opacity='0';
  el.style.transition='transform .25s ease, opacity .25s ease';
  flashHost.appendChild(el);
  requestAnimationFrame(()=>{ el.style.opacity='1'; el.style.transform='translateY(0)'; });
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-10px)'; setTimeout(()=>el.remove(), 200); }, 700);
}
// Accessibility: close modal on background click
document.getElementById('modal').addEventListener('click', (e)=>{
  if (e.target.id === 'modal') closeDeedModal();
});

// Re-binder (safety): in case of timing quirks
function bindAll(){
  ensureBind('dealBtn', ()=>{}); // no-op to ensure element exists
  // (actual handlers are already bound above; this call ensures the element is present)
}
document.addEventListener('DOMContentLoaded', bindAll);
window.addEventListener('load', bindAll);
</script>
</body>
</html>
