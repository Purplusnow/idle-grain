
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cozy Real Estate — MVP v6 (Debug)</title>
<style>
  :root{
    --bg:#0b1220; --panel:#101826; --ink:#b9d4ff; --muted:#7a8aaa; --good:#65d38a; --warn:#f5b54c; --bad:#ef6461;
    --acc:#7aa2ff; --acc2:#9b8cff;
  }
  html,body{height:100%;}
  body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#e8f0ff;
       background: radial-gradient(1200px 600px at 30% 0%, #132138, #0b1220 55%);}
  .app{display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; padding:16px; max-width:1100px; margin:0 auto;}
  header{grid-column:1/-1; display:flex; align-items:center; gap:12px; padding:10px 14px; background:#0f192a80; border:1px solid #1f2a44; border-radius:12px; position:sticky; top:8px; backdrop-filter: blur(6px);}
  .pill{background:#192743; border:1px solid #2a3a61; padding:4px 8px; border-radius:999px; font-weight:700; color:#cfe0ff; white-space:nowrap;}
  .stat{display:flex; gap:10px; align-items:baseline; margin-right:18px;}
  .stat .v{font-size:1.6rem; font-weight:800; letter-spacing:.3px; color:#ffffff;}
  .stat .l{font-size:.8rem; color:#9ab0d6}
  .grow{flex:1}
  .btn{cursor:pointer; user-select:none; padding:14px 16px; border-radius:12px; border:1px solid #2a3a61; background:#162443; color:#e8f0ff; font-weight:700; transition:.12s transform, .12s opacity, .12s background; text-align:center; pointer-events:auto;}
  .btn:hover{transform:translateY(-1px); background:#1a2b52;}
  .btn:active{transform:translateY(0); opacity:.9;}
  .btn[disabled]{opacity:.5; filter:grayscale(.3); cursor:not-allowed; transform:none;}
  .card{background:#0f192a; border:1px solid #1e2b4a; border-radius:14px; padding:14px; box-shadow: 0 0 0 1px #0a1325 inset; }
  .col{display:flex; flex-direction:column; gap:16px;}
  .tower{min-height:520px; display:flex; flex-direction:column; justify-content:flex-end; gap:6px; padding:10px; background:linear-gradient(180deg, #0f1a31, #0c1426); border-radius:14px; border:1px solid #1c2a49; overflow:hidden; position:relative;}
  .skyline{position:absolute; inset:0; opacity:.25; background-size:cover; background-position:center bottom; mix-blend:screen; border-radius:14px; pointer-events:none;}
  .tile{height:36px; border-radius:8px; display:flex; align-items:center; gap:10px; padding:6px 8px; background:linear-gradient(180deg, #1a2b52, #152443); border:1px solid #29406b;}
  .icon{width:24px; height:24px; border-radius:6px; background: linear-gradient(160deg, #7aa2ff, #9b8cff); display:grid; place-items:center; font-weight:900; color:#0b1220;}
  .tile .name{font-weight:700; color:#e6eeff;}
  .tile .meta{margin-left:auto; color:#9ab0d6; font-weight:700; font-size:.9rem;}
  .panel{display:grid; gap:12px;}
  .two{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  .notice{font-size:.9rem; color:#a8bbdf}
  .bar{height:10px; background:#0f192a; border:1px solid #1e2b4a; border-radius:999px; overflow:hidden;}
  .bar>div{height:100%; background:linear-gradient(90deg, #3fbf88, #7fd7a7); width:0%;}
  .h2{font-weight:800; color:#d9e6ff; letter-spacing:.2px; margin:4px 0 8px}
  .muted{color:#8da2c7}
  .price{color:#f5d67a; font-weight:800}
  .good{color:#65d38a; font-weight:800}
  .warn{color:#f5b54c; font-weight:800}
  .danger{color:#ef8886; font-weight:800}
  .grid-mini{display:grid; grid-template-columns:repeat(4,1fr); gap:8px;}
  .mini{aspect-ratio:1/1; background:#13223d; border:1px solid #22355a; border-radius:10px; display:grid; place-items:center; font-weight:800; color:#bcd0ff}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .small{font-size:.9rem;}
  .ghost{opacity:.6}
  .footer{grid-column:1/-1; text-align:center; color:#7a8aaa; font-size:.85rem; padding-bottom:12px}

  /* Debug panel */
  #dbg{position:fixed; left:10px; bottom:10px; z-index:9999; width:min(64vw,740px);}
  #dbg .head{display:flex; align-items:center; gap:8px; padding:6px 8px; background:#0f192a; border:1px solid #213255; border-radius:8px 8px 0 0;}
  #dbg .head strong{font-size:12px}
  #dbg .head .right{margin-left:auto; display:flex; gap:6px;}
  #dbg textarea{width:100%; height:22vh; resize:vertical; background:#0b1426; color:#e5e7eb; border:1px solid #213255; border-top:none; border-radius:0 0 8px 8px; padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; line-height:1.35; white-space:pre-wrap;}
  #dbg button{cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid #2a3a61; background:#13223d; color:#e5e7eb; font-weight:700; font-size:12px;}

  /* Debug drawer (left slide) */
  #dbg{position:fixed; left:0; top:0; height:100%; width:380px; z-index:9999;
       transform: translateX(calc(-100% + 36px)); transition: transform .2s ease;}
  #dbg.open{ transform: translateX(0); }
  #dbg .tab{ position:absolute; right:-36px; top:40%; width:36px; height:120px; cursor:pointer;
             background:#0f192a; border:1px solid #213255; border-left:none; border-radius:0 8px 8px 0;
             display:grid; place-items:center; box-shadow:0 2px 8px rgba(0,0,0,.3); }
  #dbg .tab span{ writing-mode:vertical-rl; transform:rotate(180deg); font-size:12px; font-weight:800; color:#cbd5e1; letter-spacing:.8px; }
  #dbg .head{ border-radius:0; }
  #dbg textarea{ height: calc(100% - 44px); }


  /* Deed modal tidy & minimal */
  .modal{ position:fixed; inset:0; background:rgba(8,14,24,.66); backdrop-filter: blur(2px); 
          display:none; align-items:center; justify-content:center; z-index:5000; }
  .modal.show{ display:flex; }
  .modal .box{ width: clamp(360px, 60vw, 520px) !important; max-height: 72vh; overflow:hidden; 
               display:flex; flex-direction:column; align-items:center; gap:12px; }
  .modal .art{ max-width: 240px; width: 100%; aspect-ratio: 3/4; border-radius: 14px; display:block; }
  .modal .controls{ display:none !important; }
  .modal .info{ display:none !important; }
  .modal .h2{ align-self:center; }


  /* Ensure modal is visibly on top and interactive */
  .modal{ position:fixed; inset:0; background:rgba(8,14,24,.66); backdrop-filter: blur(2px);
          display:none; align-items:center; justify-content:center; z-index: 9000; opacity:1; pointer-events:auto; }
  .modal.show{ display:flex; }
  .modal .deedTitle{ font-size:28px; font-weight:800; color:#eaf2ff; text-align:center; }

</style>
</head>
<body>
<div class="app">
  <header>
    <span class="pill" id="verPill">v12.1</span>
    <div class="stat"><span class="l">Cash</span><span id="cash" class="v">0</span></div>
    <div class="stat"><span class="l">Rent / sec</span><span id="rps" class="v">0</span></div>
    <div class="stat"><span class="l">Equity</span><span id="equity" class="v">0</span></div>
    <div class="grow"></div>
    <span id="userStatus" class="small muted" style="margin-left:auto">Not signed in</span>
<button class="btn small" id="authBtn" title="Sign in/out" style="min-width:96px">Sign in</button>
<button class="btn ghostbtn small" id="resetBtn" title="Reset local save">Reset</button>
  </header>

  <div class="col">
    <div class="card tower">
      <div id="skyline" class="skyline"></div>
      <div class="row"><div class="h2">Your City</div><div class="muted small" id="zoneLabel">Zone: Suburb</div></div>
      <div id="stack"></div>
    </div>

    <div class="card">
      <div class="h2">Milestones</div>
      <div class="notice">Buy buildings to unlock new zones and small bonuses.</div>
      <div class="bar" title="Progress to next zone">
        <div id="zoneBar"></div>
      </div>
      <div class="row small" style="margin-top:8px;">
        <div class="muted">Next milestone at <span id="nextMilestone">6</span> buildings</div>
        <div class="good" id="bonusHint">Zone bonus: +10% rent when unlocked</div>
      </div>
    </div>

    <div class="card">
      <div class="h2">Active Bonuses</div>
      <div class="row small"><div class="muted">Zone Bonus</div><div class="good"><span id="zoneBonusNow">+0%</span></div></div>
      <div class="row small"><div class="muted">Renovation</div><div class="good">×<span id="renoMultNow">1.00</span></div></div>
      <div class="row small"><div class="muted">Prestige</div><div class="good">×<span id="prestigeMultNow">1.00</span></div></div>
    </div>
  </div>

  <div class="col">
    <div class="card panel">
      <div class="h2">Actions</div>
      <div class="two">
        <button id="dealBtn" class="btn">Deal (+$25)</button>
        <button id="buyBtn" class="btn"><span id="buyLabel">Buy next</span> <span class="price" id="buyPrice"></span></button>
      </div>
      <div class="two">
        <div class="card">
          <div class="row"><div class="h2">Renovation</div><div class="muted">Lv <span id="renoLv">0</span>/5</div></div>
          <div class="muted small">Multiply all rent</div>
          <div class="row" style="margin-top:8px;">
            <button id="renoBtn" class="btn small">Upgrade</button>
            <div class="price" id="renoPrice"></div>
          </div>
        </div>
        <div class="card">
          <div class="row"><div class="h2">Manager</div><div class="muted">Lv <span id="mgrLv">0</span>/5</div></div>
          <div class="muted small">Softer price growth</div>
          <div class="row" style="margin-top:8px;">
            <button id="mgrBtn" class="btn small">Upgrade</button>
            <div class="price" id="mgrPrice"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row"><div class="h2">Reinvest</div><div class="muted">Prestige</div></div>
        <div class="muted small">Convert lifetime cash into <b>Equity</b> for a permanent multiplier. Resets buildings & upgrades.</div>
        <div class="row" style="margin-top:8px;">
          <div class="good">Potential Equity: <span id="eqPreview">0</span></div>
          <button id="prestigeBtn" class="btn">Reinvest</button>
        </div>
        <div class="row small" style="margin-top:6px;">
          <div class="muted">Lifetime cash:</div>
          <div class="muted"><span id="lifeNow">0</span></div>
        </div>
        <div class="row small">
          <div class="muted">Next Equity at:</div>
          <div class="warn" id="nextEqAt">1.0 M</div>
        </div>
        <div class="bar" title="Progress to next equity" style="margin-top:6px;">
          <div id="eqBar"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="h2">Portfolio (recent)</div>
      <div id="miniGrid" class="grid-mini"></div>
    </div>
  </div>

  <div class="footer">Cozy Real Estate — v6 (debug). Local save only. Replace SVG placeholders with AI art later.</div>
</div>

<!-- Deed Modal -->
<div id="modal" class="modal" aria-hidden="true" style="position:fixed; inset:0; display:none; place-items:center; background:rgba(5,10,20,.55); backdrop-filter: blur(2px);">
  <div class="box" style="background:#101a2d; border:1px solid #22345a; border-radius:16px; width:min(680px, 92vw); padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
    <div class="art" id="deedArt" style="background:#0b1426; border:1px solid #203058; border-radius:12px; aspect-ratio:3/4; display:grid; place-items:center;"></div>
    <div class="controls">
      <div class="h2">New Deed</div>
      <div class="muted" style="margin-bottom:8px;">You purchased <b id="deedName"></b>. Give it a nickname and download its PNG certificate.</div>
      <label class="small muted">Nickname</label>
      <input id="deedInput" type="text" placeholder="e.g., Maple St. 12" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3a61; background:#0f192a; color:#e8f0ff; font-weight:700;" />
      <div class="row" style="margin-top:12px;">
        <button id="savePngBtn" class="btn">Save PNG</button>
        <button id="closeModalBtn" class="btn ghostbtn">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Debug Console -->
<div id="dbg">
  <div class="tab" id="dbgTab" title="Toggle debug"><span>DEBUG</span></div>
  <div class="head">
    <strong>Debug</strong>
    <span id="dbgStatus" class="muted">(live)</span>
    <div class="right">
      <button id="dbgPause">Pause</button>
      <button id="dbgCopy">Copy</button>
      <button id="dbgExport">Export</button>
      <button id="dbgRebind">Rebind</button>
      <button id="dbgAdd100">+Test $100</button>
      <button id="dbgClear" class="ghost">Clear</button>
    </div>
  </div>
  <textarea id="dbgRaw" spellcheck="false" placeholder="[debug logs]"></textarea>
</div>

<script>
'use strict';
// ====== Utility ======
function fmt(n){
  if (!isFinite(n)) return '0';
  if (n < 1e3) return Math.round(n).toString();
  const units = ['','K','M','B','T','Qa','Qi'];
  let i=0; while(n>=1000&&i<units.length-1){n/=1000;i++;}
  return (Math.floor(n*10)/10).toFixed(1)+' '+units[i];
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function shade(hex, p){
  const c = parseInt(hex.slice(1),16); let r=(c>>16)&255, g=(c>>8)&255, b=c&255;
  const t = p<0?0:255, P=Math.abs(p)/100; r=Math.round((t-r)*P)+r; g=Math.round((t-g)*P)+g; b=Math.round((t-b)*P)+b;
  return `#${(1<<24 | (r<<16)|(g<<8)|b).toString(16).slice(1)}`;
}
function zoneColor(z){ return {'Suburb':'#7aa2ff','Downtown':'#9b8cff','Seaside':'#22c55e','Skyline':'#f59e0b'}[z] || '#7aa2ff'; }

// ====== Debug logger ======
const DBG_KEY='cozyRE_dbg_v6'; let DBG_LOGS=[]; let DBG_PAUSED=false;
const dbgRaw = document.getElementById('dbgRaw'); const dbgStatus=document.getElementById('dbgStatus');
function dbgSave(){ try{ localStorage.setItem(DBG_KEY, JSON.stringify(DBG_LOGS.slice(-4000))); }catch(e){} }
function dbgAppend(line){
  const atBottom = Math.abs((dbgRaw.scrollTop + dbgRaw.clientHeight) - dbgRaw.scrollHeight) < 8;
  DBG_LOGS.push(line); dbgSave();
  if (!DBG_PAUSED){
    dbgRaw.value += (dbgRaw.value? '\\n' : '') + line;
    if (atBottom) dbgRaw.scrollTop = dbgRaw.scrollHeight;
  }else{ dbgStatus.textContent='(paused)'; }
}
function debugMsg(msg){
  const t = new Date(); const h=String(t.getHours()).padStart(2,'0'), m=String(t.getMinutes()).padStart(2,'0'), s=String(t.getSeconds()).padStart(2,'0');
  const line = `[${h}:${m}:${s}] ${msg}`; console.log(line); dbgAppend(line);
}
(function(){ try{ const raw=localStorage.getItem(DBG_KEY); if(raw){ DBG_LOGS=JSON.parse(raw)||[]; dbgRaw.value=DBG_LOGS.join('\\n'); dbgRaw.scrollTop=dbgRaw.scrollHeight; } }catch(e){} })();
window.addEventListener('error', e=> debugMsg('Error: '+(e.message||e)));
window.addEventListener('unhandledrejection', e=> debugMsg('Promise: '+(e.reason && (e.reason.message||e.reason))));
document.getElementById('dbgPause').onclick=()=>{ DBG_PAUSED=!DBG_PAUSED; dbgStatus.textContent=DBG_PAUSED?'(paused)':'(live)'; if(!DBG_PAUSED){ dbgRaw.value = DBG_LOGS.join('\\n'); dbgRaw.scrollTop=dbgRaw.scrollHeight; } };
document.getElementById('dbgCopy').onclick=async ()=>{ try{ await navigator.clipboard.writeText(DBG_LOGS.join('\\n')); debugMsg('copied logs'); }catch(e){ debugMsg('copy failed: '+e.message); } };
document.getElementById('dbgExport').onclick=()=>{ try{ const blob=new Blob([DBG_LOGS.join('\\n')], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cozyRE_debug.txt'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 500); debugMsg('exported logs'); }catch(e){ debugMsg('export failed: '+e.message); } };
document.getElementById('dbgClear').onclick=()=>{ DBG_LOGS=[]; dbgSave(); dbgRaw.value=''; debugMsg('logs cleared'); };
document.getElementById('dbgAdd100').onclick=()=>{ S.cash+=100; S.lifetime+=100; renderHUD(); debugMsg('manual +$100'); };
document.getElementById('dbgRebind').onclick=()=>{ bindAll(true); };

// Debug drawer toggle + persist
(function(){
  const dbgBox=document.getElementById('dbg');
  const dbgTab=document.getElementById('dbgTab');
  try{ if(localStorage.getItem('cozyRE_dbg_open')==='1'){ dbgBox.classList.add('open'); } }catch(e){}
  if(dbgTab && !dbgTab.__bound){
    dbgTab.addEventListener('click', ()=>{
      dbgBox.classList.toggle('open');
      try{ localStorage.setItem('cozyRE_dbg_open', dbgBox.classList.contains('open')?'1':'0'); }catch(e){}
    });
    dbgTab.__bound=true;
  }
})();

window.debugMsg = debugMsg;
debugMsg('Debug initialized');
(function envLog(){
  try{
    const ua=navigator.userAgent; const href=location.href; const origin=location.origin; const proto=location.protocol;
    const tz=new Intl.DateTimeFormat(undefined,{timeZoneName:'short'}).format(new Date()).split(' ').slice(-1)[0];
    let lsOK=false; try{ localStorage.setItem('__t','1'); localStorage.removeItem('__t'); lsOK=true; }catch(_){ }
    debugMsg(`[Env] ua=${ua}`);
    debugMsg(`[Env] href=${href} origin=${origin} proto=${proto} tz=${tz} localStorage=${lsOK}`);
    const raw=localStorage.getItem(SAVE_KEY); debugMsg(`[Env] local save present=${!!raw} size=${raw?raw.length:0}`);
  }catch(e){ debugMsg('[Env] log error: '+e.message); }
})();

// ====== Game Data ======
const ZONES=['Suburb','Downtown','Seaside','Skyline'];
const milestoneSteps=[6,12,18,24];
function buildingAt(i){
  const names=["Shack","Tiny House","Duplex","Family Home","Townhouse Row","Suburban Plaza",
    "Studio Flat","Corner Café","Boutique Shop","Office Low-Rise","Small Hotel","Business Center",
    "Beach Hut","Fisher’s Cottage","Marina Shop","Boardwalk Café","Seaside Inn","Oceanfront Condo",
    "High-Rise Apt","Tech Hub","Luxury Condo","Corporate Tower","Grand Hotel","Signature Skyscraper"];
  if (i<0) i=0; if (i>=names.length) i=names.length-1;
  const zone = ZONES[Math.floor(i/6)]||ZONES[ZONES.length-1];
  const basePrice = 100 * Math.pow(1.7, i);
  const baseRps   = 1   * Math.pow(1.5, i);
  return { id:i+1, name:names[i], zone, price:basePrice, rps:baseRps };
}

// ====== State ======
const SAVE_KEY='cozyRE_mvp_v6';
function defaultState(){ return { cash:0, rps:0, equity:0, lifetime:0, buildings:[], nextIndex:0, upgrades:{reno:0,mgr:0}, last:Date.now(), zoneUnlocked:0 }; }
let S = defaultState();


// Track if we had a local save before boot (for merge policy)
const _hadLocalBeforeBoot = !!localStorage.getItem(SAVE_KEY);
window._hadLocalSave = _hadLocalBeforeBoot;

// Load & offline
(function(){
  try{ const raw = localStorage.getItem(SAVE_KEY); if(raw){ Object.assign(S, JSON.parse(raw)); debugMsg('Loaded save'); } else { debugMsg('No save found (fresh)'); } }catch(e){ debugMsg('Load error: '+e.message); }
  const now=Date.now(); const dt=Math.min(8*3600, Math.max(0, Math.floor((now-(S.last||now))/1000)));
  if (dt>0){ const gain=getRps()*dt; S.cash+=gain; S.lifetime+=gain; debugMsg(`Offline gain +$${fmt(gain)} for ${dt}s`); }
  S.last=now;
  try{ debugMsg(`[Boot] local summary buildings=${(S.buildings||[]).length} next=${S.nextIndex||0} rps=${S.rps||0} cash=${S.cash||0} eq=${S.equity||0} life=${S.lifetime||0} last=${S.last}`); }catch(_){}
})();
function save(){
  const prev=S.last; S.last=Date.now();
  try{
    const j=JSON.stringify(S);
    localStorage.setItem(SAVE_KEY, j);
    debugMsg(`[Game] save(local) len=${j.length} buildings=${(S.buildings||[]).length} next=${S.nextIndex||0} rps=${S.rps||0} cash=${S.cash||0} eq=${S.equity||0} life=${S.lifetime||0} last=${S.last}`);
  }catch(e){ debugMsg('Save error: '+e.message);} 
  try{ if (window.throttleCloudSave) window.throttleCloudSave(); }catch(_){}
}
setInterval(save, 3000);

// ====== Economy ======
function renovationMult(){ return Math.pow(1.25, S.upgrades.reno||0); }
function priceGrowthFactor(){ return 1 - (S.upgrades.mgr||0)*0.02; }
function zoneBonusMult(){ const unlocked=Math.min(4, Math.floor(S.buildings.length/6)+1); return 1 + 0.10 * Math.max(0, unlocked - 1); }
function prestigeMult(){ return Math.pow(1.02, (S.equity||0)); }
function getRps(){ const base=S.buildings.reduce((a,b)=>a+b.rps,0); return base * renovationMult() * prestigeMult() * zoneBonusMult(); }
function nextBuilding(){
  const idx=S.nextIndex;
  const b=buildingAt(idx);
  const soften = Math.max(0.85, 1 - (S.upgrades.mgr||0)*0.03);
  b.price = 100 * Math.pow(1.7*soften, idx);
  return b;
}

// ====== UI El ======
const elCash=document.getElementById('cash'), elRps=document.getElementById('rps'), elEquity=document.getElementById('equity');
const elBuy=document.getElementById('buyBtn'), elBuyPrice=document.getElementById('buyPrice'), elBuyLabel=document.getElementById('buyLabel');
const elDeal=document.getElementById('dealBtn'), elStack=document.getElementById('stack'), elMini=document.getElementById('miniGrid');
const elRenoLv=document.getElementById('renoLv'), elRenoPrice=document.getElementById('renoPrice'), elMgrLv=document.getElementById('mgrLv'), elMgrPrice=document.getElementById('mgrPrice');
const elPrestige=document.getElementById('prestigeBtn'), elEqPrev=document.getElementById('eqPreview'), elZoneBar=document.getElementById('zoneBar'), elZoneLabel=document.getElementById('zoneLabel'), elSky=document.getElementById('skyline');

// ====== Renderers ======
function renderHUD(){
  S.rps=getRps();
  elCash.textContent=fmt(S.cash); elRps.textContent=fmt(S.rps)+'/s'; elEquity.textContent=S.equity||0;
  // Active bonus numbers
  const zb=(zoneBonusMult()-1)*100, renoM=renovationMult(), presM=prestigeMult();
  const zEl=document.getElementById('zoneBonusNow'); if(zEl) zEl.textContent=(zb>0? '+'+zb.toFixed(0): '+0')+'%';
  const rEl=document.getElementById('renoMultNow'); if(rEl) rEl.textContent=renoM.toFixed(2);
  const pEl=document.getElementById('prestigeMultNow'); if(pEl) pEl.textContent=presM.toFixed(2);
  // Next buy & Deal
  const nb = nextBuilding();
  elBuyPrice.textContent='— $'+fmt(nb.price);
  elBuyLabel.textContent='Buy: '+nb.name;
  elBuy.disabled=S.cash<nb.price || S.nextIndex>=24;
  if(S.nextIndex>=24){ elBuyLabel.textContent='All buildings owned'; elBuyPrice.textContent=''; }
  const dealPreview = Math.min(250, Math.max(25, nb.price*0.05));
  if(elDeal) elDeal.textContent=`Deal (+$${fmt(dealPreview)})`;
  // Upgrades
  const renoLv=S.upgrades.reno||0, mgrLv=S.upgrades.mgr||0;
  const renoCost=[500,2000,10000,50000,200000][renoLv]||null;
  const mgrCost=[1000,5000,20000,100000,500000][mgrLv]||null;
  elRenoLv.textContent=renoLv; elMgrLv.textContent=mgrLv;
  elRenoPrice.textContent=renoCost?('$'+fmt(renoCost)):'Maxed';
  elMgrPrice.textContent=mgrCost?('$'+fmt(mgrCost)):'Maxed';
  document.getElementById('renoBtn').disabled=!renoCost || S.cash<renoCost;
  document.getElementById('mgrBtn').disabled=!mgrCost || S.cash<mgrCost;
  // Prestige preview + thresholds
  // 2x equity rule
const base=1e7; const eq = (S.lifetime>=base) ? (Math.floor(Math.log2(S.lifetime/base))+1) : 0;
  elEqPrev.textContent=eq; elPrestige.disabled=eq<=0;
  const lifeNowEl=document.getElementById('lifeNow'); if(lifeNowEl) lifeNowEl.textContent=fmt(S.lifetime);
  // next threshold by 2x rule
const nextTarget = 1e7 * Math.pow(2, eq);
  const nextEqEl=document.getElementById('nextEqAt'); if(nextEqEl) nextEqEl.textContent=fmt(nextTarget);
  const eqBar=document.getElementById('eqBar'); if(eqBar){ const prog=Math.min(1, S.lifetime/nextTarget); eqBar.style.width=(prog*100).toFixed(1)+'%'; }
  // Subrenders
  renderStack(); renderMini(); renderZone();
}
function renderStack(){ elStack.innerHTML = S.buildings.slice(-12).map(tileHTML).join(''); }
function renderMini(){ elMini.innerHTML = S.buildings.slice(-8).map(b=>`<div class="mini" title="${escapeHtml(b.name)}">${escapeHtml(short(b.name))}</div>`).join(''); }
function renderZone(){
  const count=S.buildings.length;
  const next=milestoneSteps.find(x=>x>count)||milestoneSteps[milestoneSteps.length-1];
  const prev=milestoneSteps.filter(x=>x<=count).slice(-1)[0]||0;
  const progress=(count-prev)/(next-prev||1);
  elZoneBar.style.width=(100*progress).toFixed(1)+'%';
  document.getElementById('nextMilestone').textContent=next;
  const zoneIdx=Math.floor(count/6); const prevZone=S.zoneUnlocked; S.zoneUnlocked=Math.min(zoneIdx, ZONES.length-1);
  if (S.zoneUnlocked!==prevZone){ debugMsg('Zone unlocked: '+ZONES[S.zoneUnlocked]+' (bonus now '+(((zoneBonusMult()-1)*100)|0)+'%)'); }
  elZoneLabel.textContent='Zone: '+ZONES[S.zoneUnlocked];
  const colors = ['#7aa2ff', '#9b8cff', '#22c55e', '#f5b54c'];
  const col = colors[S.zoneUnlocked] || '#7aa2ff';
  elSky.style.backgroundImage = `linear-gradient(0deg, rgba(122,162,255,.12), transparent 60%), url("data:image/svg+xml;utf8,${encodeURIComponent(skylineSVG(col))}")`;
}
function tileHTML(b){
  const color=zoneColor(b.zone);
  const letter=b.name.split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase();
  return `<div class="tile" style="background:linear-gradient(180deg, ${shade(color,20)}, ${shade(color,-10)}); border-color:${shade(color,-20)}">
    <div class="icon" style="background: linear-gradient(160deg, ${color}, ${shade(color,-15)});">${letter}</div>
    <div class="name">${escapeHtml(b.nick||b.name)}</div>
    <div class="meta">$${fmt(b.rps)}/s</div>
  </div>`;
}
function short(n){ return n.length>10 ? n.slice(0,9)+'…' : n; }
function skylineSVG(color){
  return `<svg xmlns='http://www.w3.org/2000/svg' width='1400' height='540' viewBox='0 0 1400 540'>
    <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='${color}' stop-opacity='0.9'/><stop offset='100%' stop-color='${color}' stop-opacity='0.0'/></linearGradient></defs>
    <rect width='1400' height='540' fill='url(#g)' opacity='0.15'/>
    <g fill='${color}' opacity='.28'>
      <rect x='20' y='320' width='60' height='220' rx='4'/>
      <rect x='120' y='280' width='90' height='260' rx='4'/>
      <rect x='260' y='360' width='110' height='180' rx='4'/>
      <rect x='420' y='300' width='140' height='240' rx='4'/>
      <rect x='620' y='250' width='120' height='290' rx='4'/>
      <rect x='780' y='310' width='80' height='230' rx='4'/>
      <rect x='900' y='270' width='160' height='270' rx='4'/>
      <rect x='1100' y='330' width='100' height='210' rx='4'/>
      <rect x='1240' y='290' width='120' height='250' rx='4'/>
    </g></svg>`;
}

// ====== Loop ======
let lastTick=performance.now();
function loop(t){
  const dt=(t-lastTick)/1000; lastTick=t;
  const gain = getRps()*dt; if (isFinite(gain)&&gain>=0){ S.cash+=gain; S.lifetime+=gain; }
  renderHUD();
  requestAnimationFrame(loop);
}

// ====== Handlers ======
function onDeal(){ try{ const nb=nextBuilding(); const bonus=Math.min(250, Math.max(25, nb.price*0.05)); S.cash+=bonus; S.lifetime+=bonus; renderHUD(); debugMsg('Deal: +$'+fmt(bonus)); }catch(e){ debugMsg('Deal error: '+e.message); alert('Deal error: '+e.message); } }
function onBuy(){ try{ if (S.nextIndex>=24){ debugMsg('Buy: no more buildings'); return; } const b=nextBuilding(); if (S.cash<b.price){ debugMsg('Buy blocked: cash'); return; } S.cash-=b.price; S.buildings.push(b); S.nextIndex++; debugMsg('Bought: '+b.name+' @ $'+fmt(b.price)+' rps +'+fmt(b.rps)); renderHUD(); openDeedModal(b); }catch(e){ debugMsg('Buy error: '+e.message); alert('Buy error: '+e.message); } }
function onReno(){ const lv=S.upgrades.reno||0; if (lv>=5){ debugMsg('Renovation maxed'); return; } const cost=[500,2000,10000,50000,200000][lv]; if (S.cash<cost){ debugMsg('Renovation blocked: cash'); return; } S.cash-=cost; S.upgrades.reno=lv+1; debugMsg('Renovation Lv'+(lv+1)); renderHUD(); }
function onMgr(){ const lv=S.upgrades.mgr||0; if (lv>=5){ debugMsg('Manager maxed'); return; } const cost=[1000,5000,20000,100000,500000][lv]; if (S.cash<cost){ debugMsg('Manager blocked: cash'); return; } S.cash-=cost; S.upgrades.mgr=lv+1; debugMsg('Manager Lv'+(lv+1)); renderHUD(); }
function onPrestige(){ // 2x equity rule on prestige
const base=1e7; const eq = (S.lifetime>=base) ? (Math.floor(Math.log2(S.lifetime/base))+1) : 0; if (eq<=0){ debugMsg('Prestige blocked: 0 equity'); return; } if (!confirm(`Reinvest now for ${eq} Equity?`)) return; S.equity+=eq; S.cash=0; S.rps=0; S.buildings=[]; S.nextIndex=0; S.upgrades={reno:0,mgr:0}; S.lifetime=0; debugMsg('Prestige +'+eq+' Equity'); renderHUD(); save(); }
function onReset(){
  if (!confirm('Reset local save?')) return;
  const signedIn = !!(window.__cloud && window.__cloud.auth && window.__cloud.auth.currentUser);
  let wipeCloud = false;
  if (signedIn) wipeCloud = confirm('Also reset your CLOUD save?');
  try{ localStorage.removeItem(SAVE_KEY); }catch{}
  if (wipeCloud && window.resetCloudSave){ window.resetCloudSave().finally(()=> location.reload()); }
  else { location.reload(); }
}

// ====== Bindings ======
function ensureBind(el, fn){ if (!el) return; el.onclick = fn; el.addEventListener('click', fn, {passive:true}); }
function bindAll(forceLog){ ensureBind(document.getElementById('dealBtn'), onDeal); ensureBind(document.getElementById('buyBtn'), onBuy); ensureBind(document.getElementById('renoBtn'), onReno); ensureBind(document.getElementById('mgrBtn'), onMgr); ensureBind(document.getElementById('prestigeBtn'), onPrestige); ensureBind(document.getElementById('resetBtn'), onReset); if (forceLog) debugMsg('Rebound all handlers'); }
document.addEventListener('DOMContentLoaded', ()=>{ bindAll(true); renderHUD(); requestAnimationFrame(loop); debugMsg('DOMContentLoaded'); });
window.addEventListener('load', ()=> debugMsg('window.load'));
setInterval(()=>bindAll(false), 5000);

// ====== Deed Modal & PNG ======
const modal=document.getElementById('modal'); const deedArt=document.getElementById('deedArt'); const deedName=document.getElementById('deedName'); const deedInput=document.getElementById('deedInput');
var currentDeed=null;
const __closeBtn=document.getElementById('closeModalBtn'); if(__closeBtn) __closeBtn.addEventListener('click', ()=> closeDeedModal());
const __saveBtn=document.getElementById('savePngBtn'); if(__saveBtn) __saveBtn.addEventListener('click', ()=> downloadDeedPNG());
function openDeedModal(b){ currentDeed=b; deedName.textContent=b.name; deedInput.value=b.nick||''; deedArt.innerHTML=cardSVG(b); modal.style.display='grid'; modal.setAttribute('aria-hidden','false'); debugMsg('Deed modal open: '+b.name); }
function closeDeedModal(){ const nick=deedInput.value.trim(); if(currentDeed){ currentDeed.nick=nick||undefined; const idx=S.buildings.findIndex(x=>x.id===currentDeed.id); if(idx>=0) S.buildings[idx].nick=currentDeed.nick; renderHUD(); save(); } modal.style.display='none'; modal.setAttribute('aria-hidden','true'); debugMsg('Deed modal close'); }
document.getElementById('modal').addEventListener('click', (e)=>{ if (e.target.id==='modal') closeDeedModal(); });

function cardSVG(b){
  const zone=b.zone, color=zoneColor(zone); const title=escapeHtml(b.nick||b.name);
  const windows = Array.from({length:6}).map((_,r)=>Array.from({length:6}).map((_,c)=>{
      const x=190 + c*40, y=70 + r*40; return `<rect x="${x}" y="${y}" width="18" height="22" rx="3" fill="#0b1220" opacity=".35"/>`;
  }).join('')).join('');
  return `<svg xmlns="http://www.w3.org/2000/svg" width="750" height="1000" viewBox="0 0 750 1000">
    <defs><linearGradient id="bg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${shade(color,20)}"/><stop offset="100%" stop-color="${shade(color,-10)}"/></linearGradient>
      <linearGradient id="shine" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ffffff" stop-opacity=".25"/><stop offset="100%" stop-color="#ffffff00"/></linearGradient></defs>
    <rect x="0" y="0" width="750" height="1000" rx="36" fill="url(#bg)"/><rect x="8" y="8" width="734" height="984" rx="30" fill="#0b1220" opacity=".15"/>
    <g transform="translate(60,260)">
      <rect x="120" y="120" width="390" height="380" rx="12" fill="${shade(color,-20)}"/>
      <rect x="170" y="80" width="320" height="330" rx="12" fill="${shade(color,-5)}"/>
      <rect x="210" y="40" width="240" height="260" rx="12" fill="${color}"/>
      ${windows}
      <rect x="120" y="120" width="390" height="380" rx="12" fill="url(#shine)"/>
    </g>
    <text x="375" y="820" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-weight="800" font-size="40" fill="#eaf2ff">${title}</text>
    <text x="375" y="870" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-weight="700" font-size="26" fill="#cbd8f3">${zone}</text></svg>`;
}
async function downloadDeedPNG(){
  const svgEl=deedArt.querySelector('svg'); if (!svgEl) return;
  const nick=(deedInput.value.trim() || currentDeed.name).replace(/[^\w\- ]+/g,'');
  const svgData=new XMLSerializer().serializeToString(svgEl);
  const svgBlob=new Blob([svgData], {type:'image/svg+xml;charset=utf-8'}); const url=URL.createObjectURL(svgBlob);
  const img=new Image(); img.onload=function(){
    const canvas=document.createElement('canvas'); canvas.width=svgEl.viewBox.baseVal.width||750; canvas.height=svgEl.viewBox.baseVal.height||1000;
    const ctx=canvas.getContext('2d'); ctx.fillStyle='#0b1220'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0);
    canvas.toBlob((blob)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${nick||'deed'}.png`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }, 'image/png');
    URL.revokeObjectURL(url);
  }; img.src=url;
}

// Init skyline + run loop
(function initSky(){
  const elSky=document.getElementById('skyline');
  const baseCol='#7aa2ff';
  elSky.style.backgroundImage = `linear-gradient(0deg, rgba(122,162,255,.12), transparent 60%), url("data:image/svg+xml;utf8,${encodeURIComponent(skylineSVG(baseCol))}")`;
  debugMsg('Skyline initialized');
})();
renderHUD(); requestAnimationFrame(loop);

// Minimal deed modal (SVG card only)
(function(){
  const modal=document.getElementById('modal');
  const deedArt=document.getElementById('deedArt');
  const deedName=document.getElementById('deedName');
  window.openDeedModal = function(b){
    currentDeed=b;
    if(deedName) deedName.textContent=b.name;
    if(deedArt) deedArt.innerHTML = cardSVG(b);
    modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); debugMsg('Deed modal open (minimal): '+b.name);
  };
  window.closeDeedModal = function(){
    modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); debugMsg('Deed modal close (minimal)');
  };
})();


// Ensure deed modal opens after a successful purchase
(function(){
  const __orig_onBuy = onBuy;
  window.onBuy = function(){
    const before = S.nextIndex || 0;
    __orig_onBuy();
    try{
      const after = S.nextIndex || 0;
      if (after > before){
        const b = buildingAt(after - 1);
        if (b) openDeedModal(b);
      }
    }catch(e){ debugMsg('Deed hook error: '+e.message); }
  };
})();
// Overlay click closes; clicks inside box don't bubble
(function(){
  const modal = document.getElementById('modal');
  if(modal && !modal.__bound){
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeDeedModal(); });
    const box = modal.querySelector('.box');
    if(box) box.addEventListener('click', (e)=> e.stopPropagation());
    modal.__bound = true;
  }
})();


// Hardened: force modal visible
(function(){
  const modal=document.getElementById('modal');
  const deedArt=document.getElementById('deedArt');
  const deedName=document.getElementById('deedName');
  window.openDeedModal = function(b){
    try{
      currentDeed=b;
      if(deedName) deedName.textContent=b.name;
      if(deedArt) deedArt.innerHTML = cardSVG(b);
      modal.classList.add('show');
      modal.style.display='flex';
      modal.setAttribute('aria-hidden','false');
      debugMsg('Deed modal forced visible (r5).');
    }catch(e){ debugMsg('openDeedModal error: '+e.message); }
  };
  window.closeDeedModal = function(){
    try{
      modal.classList.remove('show');
      modal.style.display='none';
      modal.setAttribute('aria-hidden','true');
    }catch(e){ debugMsg('closeDeedModal error: '+e.message); }
  };
})();

</script>

<!-- Firebase Google Sign-In + Firestore Cloud Save (v11, keys from v2) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider,
    signInWithPopup, signInWithRedirect, getRedirectResult,
    onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC17xJK5XlYIYb02CQ_Ct1CjOBvhG-aAcA",
    authDomain: "purple-idle-grain.firebaseapp.com",
    projectId: "purple-idle-grain",
    storageBucket: "purple-idle-grain.firebasestorage.app",
    messagingSenderId: "656984023401",
    appId: "1:656984023401:web:4664d1f27daee178bfddf8",
    measurementId: "G-HSJ4J8CFZL"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
debug(`[CloudInit] app=${app?.name||'n/a'} authDomain=${firebaseConfig.authDomain} projectId=${firebaseConfig.projectId}`);
try{ debug(`[CloudInit] origin=${location.origin} proto=${location.protocol}`); }catch(_){}

  // ---- debug helpers (logs only) ----
  function __sizeJson(o){ try{ return JSON.stringify(o).length; }catch(_){ return -1; } }
  function __sumState(st){ try{ st=st||{}; return `bld=${(st.buildings||[]).length} next=${st.nextIndex||0} rps=${st.rps||0} cash=${st.cash||0} eq=${st.equity||0} life=${st.lifetime||0} last=${st.last||0}`; }catch(_){ return '(n/a)'; } }

  // expose minimal cloud handles for non-module code
  window.__cloud = { auth, db };
  window.resetCloudSave = async function(){
    try{
      const u = auth.currentUser; if(!u) return;
      const ref = doc(db, 'saves', u.uid);
      const st = (window.defaultState && window.defaultState()) || {};
      st.last = Date.now();
      await setDoc(ref, { state: st, updatedAt: serverTimestamp() }, { merge:false });
      debug('Cloud save reset to defaults.');
    }catch(e){ debug('Cloud reset error: '+e.message); }
  };

  const debug = (msg) => { try{ if (window.debugMsg) window.debugMsg('[Cloud] ' + msg); else console.log('[Cloud]', msg); }catch{} };

  function mergeState(remote) {
    const base = (window.defaultState && window.defaultState()) || {};
    const merged = { ...base, ...(remote||{}) };
    if (Array.isArray(base.buildings) || Array.isArray(remote?.buildings)) {
      merged.buildings = Array.isArray(remote?.buildings) ? remote.buildings : [];
    }
    merged.upgrades = { ...(base.upgrades||{reno:0,mgr:0}), ...((remote&&remote.upgrades)||{}) };
    merged.last = typeof remote?.last === 'number' ? remote.last : Date.now();
    merged.nextIndex = typeof remote?.nextIndex === 'number' ? remote.nextIndex : (merged.buildings?.length||0);
    merged.zoneUnlocked = typeof remote?.zoneUnlocked === 'number' ? remote.zoneUnlocked : 0;
    merged.cash = Number.isFinite(remote?.cash) ? remote.cash : 0;
    merged.rps = Number.isFinite(remote?.rps) ? remote.rps : 0;
    merged.equity = Number.isFinite(remote?.equity) ? remote.equity : 0;
    merged.lifetime = Number.isFinite(remote?.lifetime) ? remote.lifetime : 0;
    return merged;
  }
  function removeUndefined(obj) {
    if (Array.isArray(obj)) return obj.map(v => removeUndefined(v));
    if (obj && typeof obj === 'object') return Object.fromEntries(Object.entries(obj).map(([k,v])=>[k, removeUndefined(v)]));
    return obj === undefined ? null : obj;
  }
  function isEphemeralLocal(st){
    if (!st) return true;
    const noBuildings = !st.buildings || st.buildings.length === 0;
    const nearZeroCash = (st.cash||0) < 5;
    const baseUp = !st.upgrades || ((st.upgrades.reno||0)===0 && (st.upgrades.mgr||0)===0);
    return noBuildings && nearZeroCash && baseUp;
  }

  async function cloudLoad(uid){
  debug(`cloudLoad: path=saves/${uid}`);
    try{
      const ref = doc(db, 'saves', uid);
      const snap = await getDoc(ref);
      const exists = snap.exists();
      const data = exists ? snap.data() : null;
      const st = data && data.state ? data.state : null;
      debug(`cloudLoad: rawSize=${__sizeJson(data)} stateSize=${__sizeJson(st)} state=${__sumState(st)}`);
      debug(`cloudLoad: exists=${exists} rps=${st && st.rps !== undefined ? st.rps : 'n/a'} cash=${st && st.cash !== undefined ? st.cash : 'n/a'} last=${st && st.last !== undefined ? st.last : 'n/a'}`);
      return data;
    }catch(e){
      debug('Load failed: '+e.message);
      return null;
    }
  }
  async function cloudSave(force=false){
  try{ debug(`[Cloud] cloudSave(start) reason=${force?'force':'auto'} local=${__sumState(window.S)} size=${__sizeJson(window.S)}`); }catch(_){}
    const u = auth.currentUser; if (!u) return;
    try{
      const ref = doc(db, 'saves', u.uid);
      const cleanState = removeUndefined(window.S);
      const payload = { state: cleanState, updatedAt: serverTimestamp() };
      debug(`cloudSave: payloadSize=${__sizeJson(payload)} state=${__sumState(cleanState)}`);
      debug(`cloudSave: writing rps=${cleanState && cleanState.rps !== undefined ? cleanState.rps : 'n/a'} cash=${cleanState && cleanState.cash !== undefined ? cleanState.cash : 'n/a'} last=${cleanState && cleanState.last !== undefined ? cleanState.last : 'n/a'} ${force?'(force)':''}`);
      await setDoc(ref, payload, { merge:true });
      debug(`Saved ${force?'(force)':''} at ${new Date().toLocaleTimeString()}`);
    }catch(e){
      debug('Save failed: '+e.message);
    }
  }
  (function(){
    let last=0;
    window.throttleCloudSave = function(){
      const t = Date.now();
      if (!auth.currentUser) return;
      if (t - last >= 10000){ last = t; cloudSave().catch(()=>{}); }
    };
    window.cloudSave = cloudSave;
  })();
  setInterval(()=>{ if (auth.currentUser) cloudSave().catch(()=>{}); }, 10000);

  const userStatusEl = document.getElementById('userStatus');
  const authBtn = document.getElementById('authBtn');
  function setSignedOutUI(){ if (userStatusEl) userStatusEl.textContent='Not signed in'; if (authBtn) authBtn.textContent='Sign in'; }
  function setSignedInUI(user){ const name=user.displayName||user.email||'Signed in'; if (userStatusEl) userStatusEl.textContent=name; if (authBtn) authBtn.textContent='Sign out'; }
  authBtn?.addEventListener('click', async ()=>{
    try{ debug(`[CloudUI] auth click; hasUser=${!!auth.currentUser}`); }catch(_){}
    const user = auth.currentUser; const provider = new GoogleAuthProvider();
    if (user){ await signOut(auth); return; }
    try{ await signInWithPopup(auth, provider); }
    catch(err){
      if (err.code === 'auth/popup-blocked' || err.code === 'auth/cancelled-popup-request'){
        try{ const s=document.getElementById('status'); if(s) s.textContent='Popup blocked — redirecting to Google sign-in…'; }catch{}
        await signInWithRedirect(auth, provider); return;
      }
      debug('Sign-in error: '+(err.code||err.message));
    }
  });
  getRedirectResult(auth).then(res=>{ if(res && res.user){ debug(`Redirect sign-in ok: ${res.user.uid} ${(res.user.email||'')}`); } }).catch(err=> debug('Redirect sign-in error: '+(err.code||err.message)));

  onAuthStateChanged(auth, async (user)=>{
    try{ debug(`[Auth] state=${!!user} uid=${user?user.uid:'-'} email=${user? (user.email||''):''}`); }catch(_){}
    if (!user){ debug('Signed out'); setSignedOutUI(); return; }
    setSignedInUI(user);
    try{
      const remote = await cloudLoad(user.uid);
      if (remote && remote.state){
        const localTs  = (window.S && window.S.last) ? window.S.last : 0;
        const remoteTs = (remote.state && remote.state.last) ? remote.state.last : 0;
        const localRps = (window.S && window.S.rps) ? window.S.rps : 0;
        const remoteRps = (remote.state && remote.state.rps) ? remote.state.rps : 0;
        const eph = isEphemeralLocal(window.S);
        debug(`Compare: hadLocal=${window._hadLocalSave} ephLocal=${eph} localRps=${localRps} remoteRps=${remoteRps} localTs=${localTs} remoteTs=${remoteTs}`);
        debug(`[Compare] local=${__sumState(window.S)} remote=${__sumState(remote.state)}`);
        const preferRemote = (!window._hadLocalSave) || (remoteRps > localRps) || ((remoteRps === localRps) && (remoteTs >= localTs)) || eph;
        try{ debug(`[Decision] preferRemote=${preferRemote} reason=`+ ( (!window._hadLocalSave)?'noLocal': (remoteRps>localRps)?'higherRps': ((remoteRps===localRps && remoteTs>=localTs)?'newerTs': (eph?'localEphemeral':'localPreferred')) ) ); }catch(_){ }
        if (preferRemote){
          const _before=window.S; window.S = mergeState(remote.state);
          try{ debug(`[Apply] merged remote into local; before=${__sumState(_before)} after=${__sumState(window.S)}`); }catch(_){}
          try{ if (window.save) window.save(); if (window.renderHUD) window.renderHUD(); }catch{}
          debug(`Loaded cloud save (remoteTs=${remoteTs}, localTs=${localTs}, hadLocal=${window._hadLocalSave})`);
        } else {
          try{ debug(`[Apply] pushing local to cloud; local=${__sumState(window.S)}`); }catch(_){ }
          await cloudSave(true);
          debug(`Synced local -> cloud (remoteTs=${remoteTs}, localTs=${localTs}, hadLocal=${window._hadLocalSave})`);
        }
      } else {
        try{ debug(`[Apply] pushing local to cloud; local=${__sumState(window.S)}`); }catch(_){ }
          await cloudSave(true);
        debug('Created cloud save (no remote).');
      }
    }catch(e){ debug('Cloud sync error: '+e.message); }
  });

  window.addEventListener('beforeunload', ()=>{ try{ debug('[Lifecycle] beforeunload: saving(force)'); if (window.cloudSave) window.cloudSave(true); }catch{} });
</script>

</body>
</html>
